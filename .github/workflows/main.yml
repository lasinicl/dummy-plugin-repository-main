name: Publish Intellij Plugin

on:
  push
    
jobs:
  publish_idea_plugin:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
                  
    - name: Install jq for json manipulation
      run: sudo apt-get install jq
        
    - name: Set up oracle JDK 1.8
      run: |
        cd /usr/lib/jvm
        ls -a
        cd
        sudo apt-get install wget
        wget --header "Cookie: oraclelicense=accept-securebackup-cookie" https://javadl.oracle.com/webapps/download/GetFile/1.8.0_261-b12/a4634525489241b9a9e1aa73d9e118e6/linux-i586/jdk-8u261-linux-x64.tar.gz
        DWNLD_PATH=$PWD
        mkdir jdk8-dir
        cd jdk8-dir
        sudo tar -xvzf $DWNLD_PATH/jdk-8u261-linux-x64.tar.gz
        JDK_PATH=$PWD
        echo 'export JAVA_HOME=$JDK_PATH/jdk1.8.0_261' >> ~/.bashrc
        echo 'export PATH=$PATH:$JDK_PATH/jdk1.8.0_261/bin' >> ~/.bashrc
        source ~/.bashrc
        sudo update-alternatives --install "/usr/bin/java" "java" "$JDK_PATH/jdk1.8.0_261/bin/java" 0
        sudo update-alternatives --install "/usr/bin/javac" "javac" "$JDK_PATH/jdk1.8.0_261/bin/javac" 0
        sudo update-alternatives --set java $JDK_PATH/jdk1.8.0_261/bin/java
        sudo update-alternatives --set javac $JDK_PATH/jdk1.8.0_261/bin/javac
        java -version

    - name: Clone ballerina-lang repo
      run: git clone https://github.com/ballerina-platform/ballerina-lang.git
          
    - name: Build and publish plugin
      run: |
        version=1.2.6
        BAL_VERSION="v${version}"

        cd ballerina-lang/tool-plugins/intellij
        git checkout $BAL_VERSION
        pwd
        ./gradlew buildPlugin 
