name: Publish Intellij Plugin

on:
  push
    
jobs:
  publish_idea_plugin:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
                  
    - name: Install jq for json manipulation
      run: sudo apt-get install jq
        
    - name: Set up oracle JDK 1.8
      run: |
        sudo apt-get install wget
        wget --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=15JWpFx3ATzUqT_2uMxxVs5v88JpttB5P' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=15JWpFx3ATzUqT_2uMxxVs5v88JpttB5P" -O jdk-8u251-linux-x64.tar.gz && rm -rf /tmp/cookies.txt
        DWNLD_PATH=$PWD
        cd /usr/lib/jvm
        sudo rm -rfv /usr/lib/jvm/*
        sudo tar -xvzf $DWNLD_PATH/jdk-8u251-linux-x64.tar.gz
        JDK_PATH=$PWD
        echo 'export JAVA_HOME=$JDK_PATH/jdk1.8.0_251' >> ~/.profile
        echo 'export PATH=$PATH:$JDK_PATH/jdk1.8.0_251/bin' >> ~/.profile
        sudo update-alternatives --install "/usr/bin/java" "java" "$JDK_PATH/jdk1.8.0_251/bin/java" 0
        sudo update-alternatives --set java $JDK_PATH/jdk1.8.0_251/bin/java
        java -version
        echo $JAVA_HOME

    - name: Clone ballerina-lang repo
      run: git clone https://github.com/ballerina-platform/ballerina-lang.git
          
    - name: Build and publish plugin
      run: |
        version=1.2.6
        BAL_VERSION="v${version}"

        cd ballerina-lang/tool-plugins/intellij
        git checkout $BAL_VERSION
        ./gradlew buildPlugin 
